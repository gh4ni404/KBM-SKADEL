<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- UPDATE CSS here -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
  <!-- DataTables Buttons CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
  <!-- Bootstrap 5 Integration -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap5.min.css">


  <style>
    .table-wrapper {
      position: relative;
      overflow-x: scroll;
      height: 68vh;
    }

    .fade-out {
      animation: fadeOut 1s forwards;
    }

    @keyframes fadeOut {
      0% {
        opacity: 1;
      }

      100% {
        opacity: 0;
      }
    }

    #example thead th {
      background-color: #343a40;
      color: white;
    }
  </style>
  <title>KBM SKADEL</title>
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">

    </div>
  </nav>
  <!-- Navbar End -->

  <div class="d-block">
    <!-- Judul di sini -->
    <div class="sticky-top bg-primary p-3 min-vw-100">
      <img src="LOGO PROVINSI.png" alt="logo provinsi" class="rounded float-start m-1" width="75">
      <img src="LOGO SEKOLAH.png" alt="logo SEKOLAH" class="rounded float-end m-1" width="75">
      <h3 class="text-center text-bg-primary">LAPORAN KBM HARIAN SMKN 8 BONE</h3>
      <div class="container">
        <div class="row">
          <button onclick="fetchData('SENIN')"
            class="btn btn-secondary col-1 col-lg-1 col-md-1 col-sm-1 m-2">SENIN</button>
          <button onclick="fetchData('SELASA')"
            class="btn btn-secondary col-1 col-lg-1 col-md-1 col-sm-1 m-2">SELASA</button>
          <button onclick="fetchData('RABU')"
            class="btn btn-secondary col-1 col-lg-1 col-md-1 col-sm-1 m-2">RABU</button>
          <button onclick="fetchData('KAMIS')"
            class="btn btn-secondary col-1 col-lg-1 col-md-1 col-sm-1 m-2">KAMIS</button>
          <button onclick="fetchData('JUMAT')"
            class="btn btn-secondary col-1 col-lg-1 col-md-1 col-sm-1 m-2">JUMAT</button>
          <button onclick="fetchData('SABTU')"
            class="btn btn-secondary col-1 col-lg-1 col-md-1 col-sm-1 m-2">SABTU</button>
        </div>
      </div>
      <h4 class="text-center mt-2 text-bg-primary" id="date"></h4>

    </div>
    <!-- judul end -->

    <!-- Loading Spinner Disini-->
    <div id="loading"
      class="text-center position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-light"
      style="display: block; z-index: 1000;">
      <div class="spinner-border m-2" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Memuat, Harap tunggu...</p>
    </div>
    <!-- Loading Spinner End -->

    <!-- Tombol Print disini -->
    <div class="text-end m-3">
      <button class="btn btn-primary" onclick="printPage()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer"
          viewBox="0 0 16 16">
          <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1" />
          <path
            d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1" />
        </svg>
        Print Tabel
      </button>
    </div>
    <!-- Tombol Print end -->

    <!-- Table disini -->
    <div class="table-responsive table-wrapper mt-4">

      <table id="example" class="table table-bordered align-middle mt-2" style="width: 100%"></table>
    </div>
    <!-- Table End -->
  </div>

  <!-- Update JSS Link here -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.1/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
  <!-- DataTables Buttons JS -->
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
  <!-- Export Buttons -->
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
  <!-- JSZip (untuk Export Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script type="text/javascript">
    const baseUrl = "https://script.google.com/macros/s/AKfycbwxxDPptmg0b4BlIJJ-pie4POoeMIJjQGFEsHj7oAHHTU3YEEK9c2CCQb1n2D4UxB5YOg/exec";
    const days = ["MINGGU", "SENIN", "SELASA", "RABU", "KAMIS", "JUMAT", "SABTU"];
    const loadingData = document.getElementById("loading");

    let table;

    function fetchData(day) {
      let url = baseUrl;
      if (day) {
        url += `?day=${day}`;
      }

      fetch(url)
        .then(response => response.json())
        .then(data => {

          // Tampilkan tanggal jika data ada
          const rawDate = new Date(data.tanggal);
          const options = {
            weekday: 'long',
            day: '2-digit',
            month: 'long',
            year: 'numeric',
          };
          const formattedDate = rawDate.toLocaleDateString('id-ID', options);
          document.getElementById("date").textContent = `${formattedDate}`;

          // Memastikan jika DataTable sudah diinisialisasi
          if (!table) {
            // Filter data berdasarkan hari
            table = $("#example").DataTable({
              ajax: url,
              lengthMenu: [[-1, 10, 25, 50], ["All", 10, 25, 50]], // Tambahkan opsi "All" dengan nilai -1
              pageLength: -1, // Tampilkan semua data secara default
              columns: [
                {
                  title: "NO",
                  data: "1",
                  className: "text-center",
                },
                {
                  title: "KELAS",
                  data: "2",
                  className: "text-center",
                },
                {
                  title: "MULAI JAM KE",
                  data: "3",
                  class: "text-center",
                },
                {
                  title: "NAMA GURU MAPEL",
                  data: "4",
                },
                {
                  title: "MATA PELAJARAN",
                  data: "5",
                },
                {
                  title: "NAMA WALI KELAS",
                  data: "6",
                },
                {
                  title: "HADIR",
                  data: "7",
                  className: "text-center",
                },
                {
                  title: "SAKIT",
                  data: "8",
                  className: "text-center",
                },
                {
                  title: "IZIN",
                  data: "9",
                  className: "text-center",
                },
                {
                  title: "ALPA",
                  data: "10",
                  className: "text-center",
                },
                {
                  title: "KONDISI KELAS",
                  data: "11",
                },
                {
                  title: "DOKUMENTASI 1",
                  data: "12",
                  render: renderDoc
                },
                {
                  title: "DOKUMENTASI 2",
                  data: "13",
                  render: renderDoc
                },
                {
                  title: "DOKUMENTASI 3",
                  data: "14",
                  render: renderDoc
                },
                {
                  title: "DOKUMENTASI 4",
                  data: "15",
                  render: renderDoc
                },
                {
                  title: "PIKET PENGGANTI",
                  data: "16",
                }
              ],
              dom: 'Bfrtip',
              buttons: [
                {
                  extend: 'print',
                  text: `
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer" viewBox="0 0 16 16">
                  <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/>
                  <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1"/>
                  </svg> Print Tabel
                  `,
                  title: `
                  `,
                  customize: function (win) {
                    $(win.document.body).css('font-size', '10pt');
                    $(win.document.body).find('table').addClass('table table-bordered');
                    // $(win.document.body).find('h1').addClass('text-center').text('Laporan KBM Harian SMKN 8 Bone');
                    // $(win.document.body).find('h4').addClass('text-center mt-2').text(formattedDate);

                    $(win.document.body).prepend(`
                      <div class="d-flex justify-content-between m-4">
                        <img src="./LOGO PROVINSI.png" width="75" height="75">
                        <div class="text-center">
                          <h1>Laporan KBM Harian SMKN 8 Bone</h1>
                          <h4 class="text-center">${formattedDate}</h4>
                        </div>
                        <img src="./LOGO SEKOLAH.png" width="75" height="75">
                      </div>
                        
                    `);
                  }
                },
                {
                  extend: 'excel',
                  text: 'Export Excel',
                  className: 'btn btn-primary',
                  exportOptions: {
                    columns: ':visible'
                  }
                }
              ],
              rowId: "KELAS",
              liveAjax: true,
              createdRow: function (row, data, dataIndex) {
                // Periksa Semua sel dalam Menu
                let hasNoData = false;

                $('td', row).each(function (index, cell) {
                  if ($(cell).text() === "?") {
                    hasNoData = true;
                  }
                });
                if (hasNoData) {
                  $(row).addClass('bg-danger text-white');
                } else {
                  $(row).removeClass('bg-danger text-white');
                }
              },
            });
            table.on('xhr', function () {

              loadingData.classList.add("fade-out");
              setTimeout(() => {
                loadingData.style.display = "none";
                loadingData.style.zIndex = "-1";
              }, 1000);
            });
          } else {
            table.clear();
            table.rows.add(data.data).draw();
            loadingData.classList.add("fade-out");
            setTimeout(() => {
              loadingData.style.display = "none";
              loadingData.style.zIndex = "-1";
            }, 1000);
          }
        }).catch(error => {
          console.error("Ada yang salah nih BOSKUU:", error);
          swal("Error", "Terjadi kesalahan saat mengambil data", "error");
        });
    }

    function renderDoc(data) {
      console.log(data);
      return data === "?" || !data ? "?" : `<a href="${data}" target="_blank">Lihat Dokumentasi</a>`;
    }

    function setDefaultDay() {
      const today = new Date().getDay();
      const defaultDay = days[today];
      $("#floatingSelect").val(defaultDay).trigger("change");
    }

    function printPage() {
      window.print();
    }

    fetchData();

    setDefaultDay();
    $("#floatingSelect").change(function () {
      fetchData($(this).val());
    });

    // setInterval(() => {
    //   fetchData($("#floatingSelect").val());
    // }, 60000);

  </script>
</body>

</html>