<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap.min.css" />
  <link rel="stylesheet" type="text/css"
    href="https://cdn.datatables.net/fixedheader/3.2.0/css/fixedHeader.bootstrap.min.css" />
  <link rel="stylesheet" type="text/css"
    href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap.min.css" />
  <title>KBM SKADEL</title>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-lg col-md col-sm col-xs">
        <h3 class="text-center mb-4">LAPORAN KBM HARIAN SMKN 8 BONE</h3>
        <div class="form-group">
          <label for="dayFilter">Pilih Hari :</label>
          <select id="dayFilter" class="form-control">
            <option value="SENIN">Senin</option>
            <option value="SELASA">Selasa</option>
            <option value="RABU">Rabu</option>
            <option value="KAMIS">Kamis</option>
            <option value="JUMAT">Jumat</option>
            <option value="SABTU">Sabtu</option>
            <option value="MINGGU">Minggu</option>
          </select>
        </div>
        <h4 class="text-center mb-4" id="date"></h4>
        <h4 class="text-center mb-4" id="packageName"></h4>
        <br>
        <br>
        <br>
        <br>
        <table id="example" class="table table-striped table-bordered text-center align-middle mt-2 mb-2"
          style="width: 100%"></table>
        <br />
        <br />
        <p id="passingGrade"></p>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.2.0/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <!-- <script type="text/javascript" src="data.json"></script> -->

  <script>
    window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/speed-insights/script.js"></script>
  <script type="text/javascript">
    $(document).ready(function () {
      const baseUrl = "https://script.google.com/macros/s/AKfycbwxxDPptmg0b4BlIJJ-pie4POoeMIJjQGFEsHj7oAHHTU3YEEK9c2CCQb1n2D4UxB5YOg/exec";
      const days = ["MINGGU", "SENIN", "SELASA", "RABU", "KAMIS", "JUMAT", "SABTU"];
      let table;

      function fetchData(day = "") {
        let url = baseUrl;
        console.log("URL yang akan dipanggil: ", url);
        if (day) {
          url += `?day=${day}`;
          console.log(`Data hari ${day} diambil`);
        }

        fetch(url)
          .then(response => response.json())
          .then(data => {
            console.log(`Data hari ${day} berhasil diambil:`, data);

            // Tampilkan tanggal jika data ada
            const rawDate = new Date(data.tanggal);
            const options = {
              weekday: 'long',
              day: '2-digit',
              month: 'long',
              year: 'numeric',
            };
            const formattedDate = rawDate.toLocaleDateString('id-ID', options);
            document.getElementById("date").textContent = `${formattedDate}`;

            // Memastikan jika DataTable sudah diinisialisasi
            // if (!$.fn.DataTable.isDataTable("#example")) {
            if (!table) {
              // Filter data berdasarkan hari
              table = $("#example").DataTable({
                ajax: url,
                lengthMenu: [[-1, 10, 25, 50], ["All", 10, 25, 50]], // Tambahkan opsi "All" dengan nilai -1
                pageLength: -1, // Tampilkan semua data secara default
                columns: [
                  {
                    title: "NO",
                    data: "1",
                  },
                  {
                    title: "KELAS",
                    data: "2",
                  },
                  {
                    title: "MULAI JAM KE",
                    data: "3",
                  },
                  {
                    title: "NAMA GURU MAPEL",
                    data: "4",

                  },
                  {
                    title: "MATA PELAJARAN",
                    data: "5",

                  },
                  {
                    title: "JUMLAH JAM",
                    data: "6",

                  },
                  {
                    title: "NAMA WALI KELAS",
                    data: "7",

                  },
                  {
                    title: "HADIR",
                    data: "8",
                  },
                  {
                    title: "SAKIT",
                    data: "9",
                  },
                  {
                    title: "IZIN",
                    data: "10",
                  },
                  {
                    title: "ALPA",
                    data: "11",
                  },
                  {
                    title: "KONDISI KELAS",
                    data: "12",
                  },
                  {
                    title: "DOKUMENTASI 1",
                    data: "13",
                    render: renderDoc
                  },
                  {
                    title: "DOKUMENTASI 2",
                    data: "14",
                    render: renderDoc
                  },
                  {
                    title: "DOKUMENTASI 3",
                    data: "15",
                    render: renderDoc
                  },
                  {
                    title: "DOKUMENTASI 4",
                    data: "16",
                    render: renderDoc
                  },
                  {
                    title: "PIKET PENGGANTI",
                    data: "17",
                  }

                ],
                rowId: "KELAS",
                liveAjax: true,
                createdRow: function (row, data, dataIndex) {
                  // Periksa Semua sel dalam Menu
                  $('td', row).each(function (index, cell)) {
                    if ($(cell).text() == "?") {
                      $(cell).addClass('bg-danger');
                    }
                  }
                }
              });
            } else {
              // $("#example").DataTable().ajax.reload(null, false);
              table.clear();
              table.rows.add(data.data).draw();
            }
          }).catch(error => {
            console.error("Ada yang salah nih BOSKUU:", error);
            swal("Error", "Terjadi kesalahan saat mengambil data", "error");
          });

      }

      function renderDoc(data) {
        return data === "?" || !data ? "?" : `<a href="${data}" target="_blank">Lihat Dokumentasi</a>`;
      }

      function setDefaultDay() {
        const today = new Date().getDay();
        const defaultDay = days[today];
        $("#dayFilter").val(defaultDay).trigger("change");
      }

      fetchData();

      setDefaultDay();
      $("#dayFilter").change(function () {
        fetchData($(this).val());
      });

      setInterval(() => {
        fetchData($("#dayFilter").val());
        console.log(`Data diperbarui {fetchData}`);
      }, 60000);
    });
  </script>
</body>

</html>